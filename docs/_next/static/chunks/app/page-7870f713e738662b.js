(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{6565:function(e,t,n){Promise.resolve().then(n.bind(n,2191))},2191:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return h}});var l=n(7437),r=n(2265);class i{static getNoteNumber(e){return e<=0?-1:Math.round(69+12*Math.log2(e/440))}static getNoteName(e){return e<0?"-":["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]}static getFrequency(e){return 440*Math.pow(2,(e-69)/12)}constructor(){this.notes=Array(12).fill(0),this.cnt=Array(12).fill(0),this.baseFrequency=Array(12).fill(1e6),this.allNotes=[],this.add=(e,t)=>{let n=i.getNoteNumber(e);this.notes[n%12]=Math.max(t,this.notes[n%12]),this.cnt[n%12]++,this.baseFrequency[n%12]=Math.min(this.baseFrequency[n%12],e),this.allNotes.push({frequency:e,strength:t,cnt:1})},this.getBaseFrequency=()=>{let e={frequency:0,strength_max:0,cnt:0},t=this.allNotes.reduce((e,t)=>Math.max(e,t.frequency),0);for(let n=0;n<this.allNotes.length;n++){let l=0,r=0,i=this.allNotes[n].frequency,a=1;for(;i*a<t;){for(let e=n;e<this.allNotes.length;e++)10>Math.abs(this.allNotes[n].frequency-this.allNotes[e].frequency/a)&&(l++,r=Math.max(r,this.allNotes[e].strength));a++}(e.strength_max*Math.max(e.cnt)<r*Math.max(l)||1==this.allNotes.length)&&(e={frequency:this.allNotes[n].frequency,strength_max:r,cnt:l})}return e.frequency}}}var a=n(5284),o=n.n(a);let c=(e,t,n)=>{let l=e.length,r=[];for(let t=0;t<l-1;t++)r.push(e[t+1]-e[t]);let i=[];for(let l=t;l<Math.min(n-1,r.length-1);l++)if(r[l]>0&&r[l+1]<=0){if(e[l+1]/256<.6)continue;i.push(l+1)}return i};function s(e,t,n){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{offSetX:0,offSetY:0},{minFrequency:r,maxFrequency:a}=t,{width:o,height:c}=n,{offSetX:s,offSetY:u}=l,h=i.getNoteNumber(r),f=i.getNoteNumber(a),d=e=>(Math.log(e)-Math.log(r))/(Math.log(a)-Math.log(r))*c;for(let t=h-1;t<=f;t++){let n=(d(i.getFrequency(t))+d(i.getFrequency(t+1)))/2;!(n<0)&&(n>c||(e.fillStyle="#a6a6a6",e.font="".concat(Math.round(d(i.getFrequency(t+1))-d(i.getFrequency(t))),"px serif"),e.fillText((t+1).toString(),s,c-n+u),e.fillRect(s,c-n+u,o,2)))}}function u(){let e,t,n;let a=(0,r.useRef)(null),[u,h]=(0,r.useState)(),f=(0,r.useRef)(null),d=(0,r.useRef)(null);(0,r.useRef)(null);let g=0,m=!1,y=1820,x=864;(0,r.useEffect)(()=>{y=window.innerWidth-100,x=.8*window.innerHeight;let e=a.current;if(null==e)return;let t=e.getContext("2d");null!=t&&(t.fillStyle="#fff",t.fillRect(0,0,y,x),h(t),s(t,{minFrequency:87,maxFrequency:622},{width:y,height:x}))});let N=0,S=()=>{if(null!=u&&null!=t&&null!=e){if(u.clearRect(0,0,y,x),s(u,{minFrequency:87,maxFrequency:622},{width:y,height:x}),null!=n&&m){var l;!function(e,t,n,l,r){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{offSetX:0,offSetY:0},o=arguments.length>6?arguments[6]:void 0;arguments.length>7&&arguments[7];let{minFrequency:c,maxFrequency:s}=l,{width:u,height:h}=r,{offSetX:f,offSetY:d}=a,g=e=>(Math.log(e)-Math.log(c))/(Math.log(s)-Math.log(c))*h,m=120,y=0,x=Date.now();for(let l of t.sections)if("SETTING"===l.name)m=l.element.Tempo;else if("NOTE"==l.name){l.element.Tempo&&(m=l.element.Tempo);let t=l.element,r=t.Length/480,a=r*(6e4/m),c=(u-f)/1e4,s=(u-f)/c,d=c*a,N=u-f-(x-n-y+s)*c;if(y+=a,N+f<0||N+f>u||"R"==t.Lyric)continue;e.fillStyle="#b00";let S=parseInt(t.NoteNum.toString())+parseInt(((null!=o?o:0)*12).toString());console.log(S,t.NoteNum,o),e.fillRect(Math.max(0,N+f),h-g(i.getFrequency(S))-5,d,13),e.fillStyle="#000",e.font="13px serif",e.fillText(l.element.Lyric,N+f-15,h-g(i.getFrequency(S)))}}(u,n,N,{minFrequency:87,maxFrequency:622},{width:y,height:x},{offSetX:150,offSetY:0},null===(l=d.current)||void 0===l?void 0:l.valueAsNumber)}let r=function(e,t,n,l,r){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{offSetX:0,offSetY:0};t.fftSize=8192;let o=t.frequencyBinCount,s=n.sampleRate,u=new Uint8Array(o),{minFrequency:h,maxFrequency:f}=l,{width:d,height:g}=r,{offSetX:m,offSetY:y}=a,x=Math.trunc(h/s*8192),N=Math.trunc(f/s*8192);t.getByteFrequencyData(u);let S=[];for(let e=0;e<o-1;e++)S[e]=u[e+1]-u[e];let p=!1,q=0,M=u.indexOf(Math.max(...u)),F=e=>e/8192*s,j=c(u,x,N),v=new i;for(let e=0;e<j.length;e++){let t=F(j[e]);if(t<h||t>f)continue;let n=u[j[e]]/256;v.add(t,n),"".concat(t.toFixed(5),"	 ").concat(i.getNoteNumber(t)," 	 ").concat(i.getNoteName(i.getNoteNumber(t)),"	 strength: ").concat(256*n,"\n")}for(let t=x;t<N;t++){let n=u[t]/256*d,l=(Math.log(F(t))-Math.log(h))/(Math.log(f)-Math.log(h))*g;!p&&S[t]/265>.1&&(p=!0),p&&!q&&S[t]<=0&&u[t]/256>.6&&(q=t),e.fillStyle="#0aa",j.includes(t)&&(e.fillStyle="#ff0"),M==t&&u[t]/256>.4&&(e.fillStyle="#0f0"),e.fillRect(d-n+m,g-l+y,n,2)}return e.fillStyle="#a6a6a6",e.fillRect(d,0,2,g),v}(u,t,e,{minFrequency:87,maxFrequency:622},{width:150,height:x},{offSetX:0,offSetY:0});if(null!=f.current){let e=r.getBaseFrequency();f.current.innerText="baseFrequency: ".concat(r.getBaseFrequency()," \n noteNumber: ").concat(i.getNoteNumber(e),"\n").concat(i.getNoteName(i.getNoteNumber(e)))}g=requestAnimationFrame(S)}},p=async()=>{let n=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1}});t=(e=new AudioContext).createAnalyser();let l=e.createMediaStreamSource(n);l.connect(t),S()},q=async()=>{N=Date.now(),m=!0},M=async()=>{cancelAnimationFrame(g)},F=async()=>{m=!1},j=async e=>{let t=await new Promise((t,n)=>{let l=new FileReader;l.addEventListener("load",()=>{let e=new Uint8Array(l.result),r=o().detect(e);if(!1==r){n("Encoding not detected");return}let i=o().convert(e,{to:"UNICODE",from:r,type:"string"});t(i)}),l.addEventListener("error",()=>{n(l.error)}),l.readAsArrayBuffer(e)});return t},v=async e=>{for(let t of e.target.files){let e=await j(t);await F(),n=function(e){let t=e.split("\r\n"),n={sections:[]},l="",r={};for(let e of t)if(e.startsWith("[")&&e.endsWith("]"))""!==l&&(n.sections.push({name:l,element:r}),l="",r={}),l=null!=e.match(/\[#SETTING\]/)?"SETTING":null!=e.match(/\[#\d+\]/)?"NOTE":e.substring(1,e.length-1);else{let[t,n]=e.split("=");r[t]=n}return n}(e)}};return(0,l.jsxs)("div",{children:[(0,l.jsx)("canvas",{id:"audioBar",width:y,height:x,ref:a}),(0,l.jsxs)("div",{id:"audioBarControl",children:[(0,l.jsx)("button",{id:"recordStart",onClick:p,children:"Mic Start"}),(0,l.jsx)("button",{id:"recordStop",onClick:M,children:"Mic Stop"}),(0,l.jsx)("button",{id:"ustStart",onClick:q,children:"Note Start"}),(0,l.jsx)("button",{id:"recordStop",onClick:F,children:"UST Stop"})]}),(0,l.jsx)("div",{children:(0,l.jsx)("input",{type:"file",id:"ustInput",name:"ustInput",accept:".ust",onChange:v})}),(0,l.jsx)("div",{id:"pitch",ref:f}),"オクターブずらす :"," ",(0,l.jsx)("div",{id:"viewSetting",children:(0,l.jsx)("input",{type:"number",id:"octave",maxLength:2,defaultValue:0,ref:d})}),(0,l.jsx)("div",{children:"******************************"})]})}function h(){return(0,l.jsxs)("div",{children:[(0,l.jsx)(u,{}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{children:"使い方"}),(0,l.jsx)("p",{children:"マイクの音声をFFTした結果はMic Startボタンを押すことで表示が開始されます。"}),(0,l.jsx)("p",{children:"USTファイルを読みこんだ状態で、Note Startボタンを押すと、USTファイルの内容に従った赤いノーツが流れてきます。 Stopで再生を終了します。"}),(0,l.jsx)("p",{children:"歌ったり、一人で練習するときの参考にしてください。"}),(0,l.jsx)("h3",{children:"ある機能"}),(0,l.jsxs)("ul",{children:[(0,l.jsx)("li",{children:"ピッチの検出(疑似) とその周波数の表示/ノート番号の表示"}),(0,l.jsx)("li",{children:"ノートをオクターブごとに調整すること"})]}),(0,l.jsx)("h3",{children:"現在ない機能"}),(0,l.jsxs)("ul",{children:[(0,l.jsx)("li",{children:"表示外のノートに合わせた自動調整"}),(0,l.jsx)("li",{children:"ノートの一時停止"}),(0,l.jsx)("li",{children:"判定"})]})]})]})}}},function(e){e.O(0,[824,971,596,744],function(){return e(e.s=6565)}),_N_E=e.O()}]);